<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>JSON Attribute Inspector</title>
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: 'Inter', system-ui, sans-serif;
      font-size: 12px;
      background: #ffffff;
    }
    
    .container {
      width: 100%;
      max-width: 350px;
    }
    
    h2 {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .section {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-size: 11px;
      font-weight: 500;
      color: #666;
    }
    
    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      resize: vertical;
      box-sizing: border-box;
    }
    
    textarea:focus {
      outline: none;
      border-color: #18a0fb;
      box-shadow: 0 0 0 2px rgba(24, 160, 251, 0.2);
    }
    
    button {
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 12px;
      cursor: pointer;
      width: 100%;
      font-weight: 500;
    }
    
    button:hover {
      background: #0d8ce8;
    }
    
    button:active {
      background: #0b7dd1;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      background: white;
      cursor: pointer;
      box-sizing: border-box;
      max-height: 200px;
    }
    
    select:focus {
      outline: none;
      border-color: #18a0fb;
      box-shadow: 0 0 0 2px rgba(24, 160, 251, 0.2);
    }
    
    optgroup {
      font-weight: 600;
      font-size: 11px;
      color: #666;
      background: #f8f9fa;
      padding: 4px 0;
    }
    
    optgroup option {
      font-weight: 400;
      color: #333;
      padding-left: 12px;
      background: white;
    }
    
    .stats {
      font-size: 10px;
      color: #999;
      margin-top: 8px;
      padding: 6px 8px;
      background: #f8f9fa;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .error {
      color: #e74c3c;
      font-size: 11px;
      margin-top: 6px;
      font-style: italic;
    }
    
    .success {
      color: #27ae60;
      font-size: 11px;
      margin-top: 6px;
      font-style: italic;
    }
    
    .attributes-section {
      display: none;
    }
    
    .attributes-section.show {
      display: block;
    }
    
    /* Tab System */
    .tab-nav {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    
    .tab-button {
      background: none;
      border: none;
      padding: 12px 20px;
      font-size: 12px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
      width: auto;
    }
    
    .tab-button:hover {
      background: #f8f9fa;
      color: #333;
    }
    
    .tab-button.active {
      color: #18a0fb;
      border-bottom-color: #18a0fb;
      background: none;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .target-selection {
      margin-bottom: 12px;
    }
    
    /* Attributes Cards */
    .attributes-cards {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      background: #fafbfc;
    }
    
    .attribute-card {
      padding: 12px 16px;
      border-bottom: 1px solid #e1e5e9;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .attribute-card:last-child {
      border-bottom: none;
    }
    
    .attribute-card:hover {
      background: #f8f9fa;
      border-left: 4px solid #18a0fb;
      padding-left: 12px;
    }
    
    .attribute-card.selected {
      background: #e8f4fd;
      border-left: 4px solid #18a0fb;
      padding-left: 12px;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }
    
    .card-category {
      font-size: 10px;
      font-weight: 500;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .card-type {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 500;
      text-transform: lowercase;
    }
    
    .type-string {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .type-number {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    
    .type-boolean {
      background: #e8f5e8;
      color: #388e3c;
    }
    
    .type-object {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .type-array {
      background: #fce4ec;
      color: #c2185b;
    }
    
    .card-path {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
    }
    
    .card-value {
      font-size: 11px;
      color: #666;
      line-height: 1.4;
      word-break: break-all;
    }
    
    .search-controls {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      padding-bottom: 8px;
    }
    
    /* Array Group Cards */
    .array-group-card {
      border-left: 4px solid #c2185b;
      padding-left: 12px;
    }
    
    .array-properties {
      margin-top: 8px;
      padding: 8px;
      background: #fafbfc;
      border-radius: 4px;
      border: 1px solid #e1e5e9;
    }
    
    .array-property {
      padding: 6px 8px;
      margin-bottom: 4px;
      background: white;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .array-property:last-child {
      margin-bottom: 0;
    }
    
    .array-property:hover {
      background: #f0f8ff;
      border-color: #18a0fb;
    }
    
    .array-property.selected {
      background: #e8f4fd;
      border-color: #18a0fb;
      box-shadow: 0 0 0 1px #18a0fb;
    }
    
    .property-name {
      font-weight: 600;
      font-size: 11px;
      color: #333;
      margin-right: 8px;
    }
    
    .property-value {
      font-size: 11px;
      color: #666;
      font-family: 'Monaco', 'Menlo', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>JSON Attribute Inspector</h2>
    
    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-button active" data-tab="tab1">Layer Mapping</button>
      <button class="tab-button" data-tab="tab2">Component Properties</button>
    </div>
    
    <!-- Tab 1: Current functionality -->
    <div class="tab-content active" id="tab1">
      <!-- JSON Input Section -->
    <div class="section">
      <label for="json-input">Paste JSON Data:</label>
      <textarea 
        id="json-input" 
        placeholder='{"name": "John", "age": 30, "city": "New York", "skills": ["JavaScript", "React"]}'
      ></textarea>
      <div id="json-message"></div>
      <button id="apply-json">Apply JSON</button>
    </div>
    
    <!-- Attributes Exploration Section -->
    <div class="section attributes-section" id="attributes-section">
      <!-- Search and Filters -->
      <div class="search-controls">
        <div class="search-box">
          <input type="text" id="attribute-search" placeholder="Search attributes..." style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
        </div>
        <div class="filter-controls" style="display: flex; gap: 8px; margin-top: 8px; align-items: center;">
          <select id="type-filter" style="padding: 6px 8px; font-size: 11px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">All Types</option>
            <option value="string">String</option>
            <option value="number">Number</option>
            <option value="boolean">Boolean</option>
            <option value="object">Object</option>
            <option value="array">Array</option>
          </select>
          <select id="category-filter" style="padding: 6px 8px; font-size: 11px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">All Categories</option>
            <option value="root">Root Level</option>
            <option value="nested">Nested</option>
            <option value="arrays">Arrays</option>
            <option value="primitives">Primitives</option>
          </select>
          <div style="margin-left: auto; font-size: 11px; color: #666;">
            <span id="results-count">0 results</span>
          </div>
        </div>
      </div>
      
      <!-- Attributes Cards -->
      <div id="attributes-cards" class="attributes-cards" style="margin-top: 16px;">
        <!-- Cards will be populated here -->
      </div>
      
      <!-- Selected Attribute Info -->
      <div id="selected-attribute-card" style="display: none; margin-top: 16px; padding: 12px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #18a0fb;">
        <div style="font-weight: 600; font-size: 12px; color: #333; margin-bottom: 8px;">‚úÖ Selected Attribute</div>
        <div style="font-size: 11px; color: #666;">
          <strong>Path:</strong> <span id="selected-path"></span><br>
          <strong>Value:</strong> <span id="selected-val"></span><br>
          <strong>Type:</strong> <span id="selected-typ"></span>
        </div>
      </div>
    </div>

    <!-- Layer Mapping Section -->
    <div class="section mapping-section" id="mapping-section" style="display: none;">
      <label>üéØ Apply to Selected Layer:</label>
      <div id="layer-info" style="margin-bottom: 12px; padding: 8px; background: #e8f4fd; border-radius: 4px; font-size: 11px;">
        <div id="layer-status">Select a layer on the canvas...</div>
      </div>
      
      <label for="property-select">Apply to Property:</label>
      <select id="property-select">
        <option value="">Choose layer property...</option>
        <option value="text">üìù Text Content</option>
        <option value="fill">üé® Fill Color (hex)</option>
        <option value="width">üìè Width</option>
        <option value="height">üìê Height</option>
        <option value="x">‚û°Ô∏è X Position</option>
        <option value="y">‚¨áÔ∏è Y Position</option>
        <option value="opacity">üëª Opacity (0-1)</option>
        <option value="rotation">üîÑ Rotation (degrees)</option>
        <option value="name">üè∑Ô∏è Layer Name</option>
      </select>
      
      <div id="mapping-preview" style="display: none; margin: 12px 0; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 11px;">
        <strong>Preview:</strong> <span id="preview-text"></span>
      </div>
      
      <button id="apply-mapping" disabled>Apply to Layer</button>
      <button id="refresh-selection" style="background: #666; margin-top: 8px;">Refresh Selection</button>
    </div>
    </div>
    
    <!-- Tab 2: Component Property Mapping -->
    <div class="tab-content" id="tab2">
      <!-- Dataset Section -->
      <div class="section">
        <label>Dataset to link</label>
        <p style="font-size: 11px; color: #666; margin: 0 0 12px 0;">Search for the dataset source to use for this link</p>
        <select id="component-attribute-select">
          <option value="">Select an attribute</option>
        </select>
        <div id="component-attribute-info" style="margin-top: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 11px; display: none;">
          <strong>Selected:</strong> <span id="comp-selected-attribute"></span><br>
          <strong>Value:</strong> <span id="comp-selected-value"></span><br>
          <strong>Type:</strong> <span id="comp-selected-type"></span>
        </div>
      </div>
      
      <!-- Figma Target Section -->
      <div class="section" id="component-mapping-section" style="display: none;">
        <label>Figma target</label>
        <p style="font-size: 11px; color: #666; margin: 0 0 12px 0;">Set the target action for apply</p>
        
        <div class="target-selection">
          <label for="component-select">Component</label>
          <select id="component-select">
            <option value="">Select component...</option>
          </select>
        </div>
        
        <div class="target-selection" style="margin-top: 12px;">
          <label for="component-property-select">Property</label>
          <select id="component-property-select">
            <option value="">Select property...</option>
          </select>
        </div>
        
        <div id="component-mapping-preview" style="display: none; margin: 12px 0; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 11px;">
          <strong>Preview:</strong> <span id="component-preview-text"></span>
        </div>
        
        <button id="apply-component-mapping" disabled>Apply Component Mapping</button>
        <button id="refresh-components" style="background: #666; margin-top: 8px;">Refresh Components</button>
      </div>
    </div>
  </div>

  <script>
    let currentJsonData = null;
    let attributePaths = [];
    let selectedAttribute = null;
    let currentLayer = null;
    let componentSelectedAttribute = null;
    let availableComponents = [];

    // Tab switching functionality
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', (e) => {
        const targetTab = e.target.getAttribute('data-tab');
        switchTab(targetTab);
      });
    });

    function switchTab(tabId) {
      // Update button states
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      
      // Update content visibility
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
      
      // Populate component attribute dropdown when switching to tab 2
      if (tabId === 'tab2' && attributePaths.length > 0) {
        populateComponentAttributeDropdown();
        requestAvailableComponents();
      }
      
      // Reset search filters when switching to tab 1
      if (tabId === 'tab1' && attributePaths.length > 0) {
        document.getElementById('attribute-search').value = '';
        document.getElementById('type-filter').value = '';
        document.getElementById('category-filter').value = '';
        populateAttributeCards();
      }
    }

    // Extract all possible attribute paths from a JSON object
    function extractAttributePaths(obj, prefix = '') {
      const paths = [];
      
      for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
          const currentPath = prefix ? `${prefix}.${key}` : key;
          const value = obj[key];
          
          // Add the current path
          paths.push({
            path: currentPath,
            value: value,
            type: Array.isArray(value) ? 'array' : typeof value
          });
          
          // If it's an object (and not an array), recurse deeper
          if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
            paths.push(...extractAttributePaths(value, currentPath));
          }
          
          // If it's an array, also add paths for array elements
          if (Array.isArray(value)) {
            value.forEach((item, index) => {
              const arrayPath = `${currentPath}[${index}]`;
              paths.push({
                path: arrayPath,
                value: item,
                type: Array.isArray(item) ? 'array' : typeof item
              });
              
              // If array item is an object, recurse into it
              if (typeof item === 'object' && item !== null && !Array.isArray(item)) {
                paths.push(...extractAttributePaths(item, arrayPath));
              }
            });
          }
        }
      }
      
      return paths;
    }

    // Generate statistics about the parsed JSON
    function generateStats() {
      const stats = {
        objects: 0,
        arrays: 0,
        primitives: 0,
        strings: 0,
        numbers: 0,
        booleans: 0,
        nulls: 0
      };
      
      attributePaths.forEach(attr => {
        if (attr.value === null) {
          stats.nulls++;
          stats.primitives++;
        } else {
          switch (attr.type) {
            case 'object':
              stats.objects++;
              break;
            case 'array':
              stats.arrays++;
              break;
            case 'string':
              stats.strings++;
              stats.primitives++;
              break;
            case 'number':
              stats.numbers++;
              stats.primitives++;
              break;
            case 'boolean':
              stats.booleans++;
              stats.primitives++;
              break;
            default:
              stats.primitives++;
          }
        }
      });
      
      return stats;
    }

    // Apply JSON button click handler
    document.getElementById('apply-json').onclick = () => {
      const jsonInput = document.getElementById('json-input').value.trim();
      const messageDiv = document.getElementById('json-message');
      const attributesSection = document.getElementById('attributes-section');
      
      if (!jsonInput) {
        messageDiv.innerHTML = '<div class="error">Please paste some JSON data first.</div>';
        return;
      }
      
      try {
        // Parse the JSON
        currentJsonData = JSON.parse(jsonInput);
        
        // Extract all attribute paths
        attributePaths = extractAttributePaths(currentJsonData);
        
        // Update UI
        const stats = generateStats();
        messageDiv.innerHTML = `
          <div class="success">‚úÖ JSON parsed successfully! Found ${attributePaths.length} attributes.</div>
          <div class="stats">
            <span>üìä ${stats.objects} objects</span>
            <span>üìã ${stats.arrays} arrays</span>
            <span>üìù ${stats.primitives} primitives</span>
          </div>
        `;
        
        // Populate the cards
        populateAttributeCards();
        
        // Show the attributes section
        attributesSection.classList.add('show');
        
      } catch (error) {
        messageDiv.innerHTML = `<div class="error">‚ùå Invalid JSON: ${error.message}</div>`;
        attributesSection.classList.remove('show');
      }
    };

    let filteredAttributes = [];
    
    function populateAttributeCards() {
      filteredAttributes = [...attributePaths];
      renderAttributeCards(filteredAttributes);
      updateResultsCount(getDisplayCardCount(filteredAttributes));
    }
    
    function renderAttributeCards(attributes) {
      const container = document.getElementById('attributes-cards');
      container.innerHTML = '';
      
      if (attributes.length === 0) {
        container.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #666; font-size: 12px;">
            No attributes match your search criteria
          </div>
        `;
        return;
      }
      
      // Group array items together
      const groupedAttributes = groupArrayItems(attributes);
      
      groupedAttributes.forEach((group) => {
        if (group.isArrayGroup) {
          renderArrayGroupCard(group, container);
        } else {
          renderSingleAttributeCard(group.attr, container);
        }
      });
    }
    
    function groupArrayItems(attributes) {
      const groups = [];
      const arrayGroups = {};
      
      attributes.forEach(attr => {
        // Check if this is an array item (e.g., biomarkers[0].name)
        const arrayMatch = attr.path.match(/^([^[\]]+)\[(\d+)\]/);
        
        if (arrayMatch) {
          const arrayName = arrayMatch[1];
          const index = arrayMatch[2];
          const groupKey = `${arrayName}[${index}]`;
          
          if (!arrayGroups[groupKey]) {
            arrayGroups[groupKey] = {
              isArrayGroup: true,
              arrayName: arrayName,
              index: index,
              basePath: groupKey,
              attributes: []
            };
          }
          
          arrayGroups[groupKey].attributes.push(attr);
        } else {
          // Regular attribute, not in an array
          groups.push({
            isArrayGroup: false,
            attr: attr
          });
        }
      });
      
      // Add array groups to main groups
      Object.values(arrayGroups).forEach(group => {
        groups.push(group);
      });
      
      return groups;
    }
    
    function renderArrayGroupCard(group, container) {
      const card = document.createElement('div');
      card.className = 'attribute-card array-group-card';
      card.dataset.category = 'arrays';
      card.dataset.type = 'object';
      
      // Find the main object value for this array item
      const mainObject = attributePaths.find(attr => attr.path === group.basePath);
      const objectValue = mainObject ? mainObject.value : {};
      
      card.innerHTML = `
        <div class="card-header">
          <div class="card-category">ARRAY ITEM</div>
          <div class="card-type type-object">object</div>
        </div>
        <div class="card-path">${group.basePath}</div>
        <div class="array-properties">
          ${group.attributes.map(attr => {
            const propertyName = attr.path.replace(group.basePath + '.', '');
            return `
              <div class="array-property" data-attr-index="${attributePaths.indexOf(attr)}">
                <span class="property-name">${propertyName}:</span>
                <span class="property-value">${JSON.stringify(attr.value)}</span>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      // Add click handlers for individual properties
      card.querySelectorAll('.array-property').forEach(propElement => {
        propElement.addEventListener('click', (e) => {
          e.stopPropagation();
          const attrIndex = propElement.dataset.attrIndex;
          const attr = attributePaths[attrIndex];
          selectAttribute(attr, card);
          
          // Highlight the selected property
          card.querySelectorAll('.array-property').forEach(p => p.classList.remove('selected'));
          propElement.classList.add('selected');
        });
      });
      
      container.appendChild(card);
    }
    
    function renderSingleAttributeCard(attr, container) {
      const card = document.createElement('div');
      card.className = 'attribute-card';
      card.dataset.index = attributePaths.indexOf(attr);
      card.dataset.type = attr.type;
      card.dataset.category = getCategoryForAttribute(attr);
      
      const categoryLabel = getCategoryLabel(getCategoryForAttribute(attr));
      const truncatedValue = JSON.stringify(attr.value).length > 80 
        ? JSON.stringify(attr.value).substring(0, 80) + '...'
        : JSON.stringify(attr.value);
      
      card.innerHTML = `
        <div class="card-header">
          <div class="card-category">${categoryLabel}</div>
          <div class="card-type type-${attr.type}">${attr.type}</div>
        </div>
        <div class="card-path">${attr.path}</div>
        <div class="card-value">${truncatedValue}</div>
      `;
      
      card.addEventListener('click', () => selectAttribute(attr, card));
      container.appendChild(card);
    }
    
    function getCategoryForAttribute(attr) {
      if (!attr.path.includes('.') && !attr.path.includes('[')) {
        return 'root';
      } else if (attr.path.includes('[') && !attr.path.includes('.', attr.path.lastIndexOf('['))) {
        return 'arrays';
      } else if (attr.path.includes('.') || attr.path.includes('[')) {
        return 'nested';
      } else {
        return 'primitives';
      }
    }
    
    function getCategoryLabel(category) {
      const labels = {
        root: 'ROOT LEVEL',
        nested: 'NESTED',
        arrays: 'ARRAY ITEM', 
        primitives: 'PRIMITIVE'
      };
      return labels[category] || category.toUpperCase();
    }
    
    function selectAttribute(attr, cardElement) {
      // Remove previous selection from all cards
      document.querySelectorAll('.attribute-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // Remove previous selection from all array properties
      document.querySelectorAll('.array-property').forEach(prop => {
        prop.classList.remove('selected');
      });
      
      // Add selection to clicked card (but not for array group cards)
      if (!cardElement.classList.contains('array-group-card')) {
        cardElement.classList.add('selected');
      }
      
      // Update selected attribute
      selectedAttribute = attr;
      
      // Update selected attribute info
      document.getElementById('selected-path').textContent = attr.path;
      document.getElementById('selected-val').textContent = JSON.stringify(attr.value);
      document.getElementById('selected-typ').textContent = attr.type;
      document.getElementById('selected-attribute-card').style.display = 'block';
      
      // Show mapping section
      document.getElementById('mapping-section').style.display = 'block';
      
      // Request current layer selection from plugin
      parent.postMessage({ 
        pluginMessage: { 
          type: 'get-selection'
        } 
      }, '*');
      
      // Update mapping preview
      updateMappingPreview();
    }
    
    function updateResultsCount(count) {
      document.getElementById('results-count').textContent = `${count} result${count !== 1 ? 's' : ''}`;
    }

    // Listen for messages from the plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (msg.type === 'layer-selection') {
        currentLayer = msg.layer;
        updateLayerInfo();
      }
      if (msg.type === 'components-list') {
        availableComponents = msg.components;
        populateComponentsDropdown(msg.components);
      }
      if (msg.type === 'component-properties') {
        populateComponentPropertiesDropdown(msg.properties);
      }
    };

    // Search and filter functionality
    function filterAttributes() {
      const searchTerm = document.getElementById('attribute-search').value.toLowerCase();
      const typeFilter = document.getElementById('type-filter').value;
      const categoryFilter = document.getElementById('category-filter').value;
      
      filteredAttributes = attributePaths.filter(attr => {
        // Search filter
        const matchesSearch = !searchTerm || 
          attr.path.toLowerCase().includes(searchTerm) ||
          JSON.stringify(attr.value).toLowerCase().includes(searchTerm);
        
        // Type filter
        const matchesType = !typeFilter || attr.type === typeFilter;
        
        // Category filter
        let matchesCategory = true;
        if (categoryFilter) {
          if (categoryFilter === 'arrays') {
            // For array filter, include both array objects and their properties
            matchesCategory = attr.path.includes('[') || attr.type === 'array';
          } else {
            matchesCategory = getCategoryForAttribute(attr) === categoryFilter;
          }
        }
        
        return matchesSearch && matchesType && matchesCategory;
      });
      
      renderAttributeCards(filteredAttributes);
      updateResultsCount(getDisplayCardCount(filteredAttributes));
    }
    
    // Count how many cards will be displayed (accounting for grouping)
    function getDisplayCardCount(attributes) {
      const groups = groupArrayItems(attributes);
      return groups.length;
    }
    
    // Add event listeners for search and filters
    document.getElementById('attribute-search').addEventListener('input', filterAttributes);
    document.getElementById('type-filter').addEventListener('change', filterAttributes);
    document.getElementById('category-filter').addEventListener('change', filterAttributes);

    // Property selection handler
    document.getElementById('property-select').onchange = () => {
      updateMappingPreview();
    };

    // Apply mapping button
    document.getElementById('apply-mapping').onclick = () => {
      const property = document.getElementById('property-select').value;
      if (!selectedAttribute || !property || !currentLayer) {
        return;
      }
      
      parent.postMessage({
        pluginMessage: {
          type: 'apply-mapping',
          attribute: selectedAttribute,
          property: property,
          layer: currentLayer
        }
      }, '*');
    };

    // Refresh selection button
    document.getElementById('refresh-selection').onclick = () => {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'get-selection'
        } 
      }, '*');
    };

    // Update layer info display
    function updateLayerInfo() {
      const layerStatus = document.getElementById('layer-status');
      const applyButton = document.getElementById('apply-mapping');
      
      if (currentLayer) {
        layerStatus.innerHTML = `
          <strong>Selected:</strong> ${currentLayer.name} (${currentLayer.type})<br>
          <strong>ID:</strong> ${currentLayer.id}
        `;
        applyButton.disabled = !selectedAttribute || !document.getElementById('property-select').value;
      } else {
        layerStatus.textContent = 'No layer selected. Select a layer on the canvas.';
        applyButton.disabled = true;
      }
      
      updateMappingPreview();
    }

    // Update mapping preview
    function updateMappingPreview() {
      const previewDiv = document.getElementById('mapping-preview');
      const previewText = document.getElementById('preview-text');
      const property = document.getElementById('property-select').value;
      
      if (!selectedAttribute || !property) {
        previewDiv.style.display = 'none';
        return;
      }
      
      let preview = '';
      const value = selectedAttribute.value;
      
      switch (property) {
        case 'text':
          preview = `Set text to: "${value}"`;
          break;
        case 'fill':
          preview = `Set fill color to: ${value}`;
          break;
        case 'width':
          preview = `Set width to: ${value}px`;
          break;
        case 'height':
          preview = `Set height to: ${value}px`;
          break;
        case 'x':
          preview = `Set X position to: ${value}`;
          break;
        case 'y':
          preview = `Set Y position to: ${value}`;
          break;
        case 'opacity':
          preview = `Set opacity to: ${value}`;
          break;
        case 'rotation':
          preview = `Set rotation to: ${value}¬∞`;
          break;
        case 'name':
          preview = `Set layer name to: "${value}"`;
          break;
        default:
          preview = `Apply ${selectedAttribute.path} = ${JSON.stringify(value)}`;
      }
      
      previewText.textContent = preview;
      previewDiv.style.display = 'block';
      
      // Enable/disable apply button
      const applyButton = document.getElementById('apply-mapping');
      applyButton.disabled = !currentLayer;
    }

    // Component Tab 2 Functions
    function populateComponentAttributeDropdown() {
      const select = document.getElementById('component-attribute-select');
      select.innerHTML = '<option value="">Select an attribute</option>';
      
      // Use the same categorization as Tab 1
      const categories = {
        root: { label: "üè† Root Level", items: [] },
        primitives: { label: "üìù Primitive Values", items: [] },
        objects: { label: "üì¶ Objects", items: [] },
        arrays: { label: "üìã Arrays", items: [] },
        arrayItems: { label: "üî¢ Array Items", items: [] },
        nested: { label: "üå≤ Nested Properties", items: [] }
      };
      
      attributePaths.forEach((attr, index) => {
        const item = { attr, index };
        
        if (!attr.path.includes('.') && !attr.path.includes('[')) {
          categories.root.items.push(item);
        } else if (attr.path.includes('[') && !attr.path.includes('.', attr.path.lastIndexOf('['))) {
          categories.arrayItems.items.push(item);
        } else if (attr.type === 'object') {
          categories.objects.items.push(item);
        } else if (attr.type === 'array') {
          categories.arrays.items.push(item);
        } else if (attr.path.includes('.') || attr.path.includes('[')) {
          categories.nested.items.push(item);
        } else {
          categories.primitives.items.push(item);
        }
      });
      
      Object.values(categories).forEach(category => {
        if (category.items.length > 0) {
          const optgroup = document.createElement('optgroup');
          optgroup.label = `${category.label} (${category.items.length})`;
          
          category.items.sort((a, b) => a.attr.path.localeCompare(b.attr.path));
          
          category.items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.index;
            option.textContent = `${item.attr.path} (${item.attr.type})`;
            optgroup.appendChild(option);
          });
          
          select.appendChild(optgroup);
        }
      });
    }

    function requestAvailableComponents() {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'get-components'
        } 
      }, '*');
    }

    function populateComponentsDropdown(components) {
      const select = document.getElementById('component-select');
      select.innerHTML = '<option value="">Select component...</option>';
      
      components.forEach(component => {
        const option = document.createElement('option');
        option.value = component.id;
        option.textContent = component.name;
        select.appendChild(option);
      });
    }

    function populateComponentPropertiesDropdown(properties) {
      const select = document.getElementById('component-property-select');
      select.innerHTML = '<option value="">Select property...</option>';
      
      properties.forEach(property => {
        const option = document.createElement('option');
        option.value = property.name;
        option.textContent = property.name;
        select.appendChild(option);
      });
    }

    function updateComponentMappingPreview() {
      const previewDiv = document.getElementById('component-mapping-preview');
      const previewText = document.getElementById('component-preview-text');
      const componentSelect = document.getElementById('component-select');
      const propertySelect = document.getElementById('component-property-select');
      
      if (!componentSelectedAttribute || !componentSelect.value || !propertySelect.value) {
        previewDiv.style.display = 'none';
        return;
      }
      
      const componentName = componentSelect.options[componentSelect.selectedIndex].text;
      const propertyName = propertySelect.value;
      const value = componentSelectedAttribute.value;
      
      previewText.textContent = `Set ${componentName}.${propertyName} to: ${JSON.stringify(value)}`;
      previewDiv.style.display = 'block';
      
      // Enable/disable apply button
      const applyButton = document.getElementById('apply-component-mapping');
      applyButton.disabled = false;
    }

    // Tab 2 Event Handlers
    document.getElementById('component-attribute-select').onchange = (e) => {
      const selectedIndex = e.target.value;
      const infoDiv = document.getElementById('component-attribute-info');
      const mappingSection = document.getElementById('component-mapping-section');
      
      if (selectedIndex === '') {
        infoDiv.style.display = 'none';
        mappingSection.style.display = 'none';
        componentSelectedAttribute = null;
        return;
      }
      
      componentSelectedAttribute = attributePaths[selectedIndex];
      
      document.getElementById('comp-selected-attribute').textContent = componentSelectedAttribute.path;
      document.getElementById('comp-selected-value').textContent = JSON.stringify(componentSelectedAttribute.value);
      document.getElementById('comp-selected-type').textContent = componentSelectedAttribute.type;
      
      infoDiv.style.display = 'block';
      mappingSection.style.display = 'block';
      
      requestAvailableComponents();
      updateComponentMappingPreview();
    };

    document.getElementById('component-select').onchange = (e) => {
      const componentId = e.target.value;
      if (componentId) {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'get-component-properties',
            componentId: componentId
          } 
        }, '*');
      }
      updateComponentMappingPreview();
    };

    document.getElementById('component-property-select').onchange = () => {
      updateComponentMappingPreview();
    };

    document.getElementById('apply-component-mapping').onclick = () => {
      const componentId = document.getElementById('component-select').value;
      const property = document.getElementById('component-property-select').value;
      
      if (!componentSelectedAttribute || !componentId || !property) {
        return;
      }
      
      parent.postMessage({
        pluginMessage: {
          type: 'apply-component-mapping',
          attribute: componentSelectedAttribute,
          componentId: componentId,
          property: property
        }
      }, '*');
    };

    document.getElementById('refresh-components').onclick = () => {
      requestAvailableComponents();
    };

    // Allow pressing Enter in textarea to apply
    document.getElementById('json-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        document.getElementById('apply-json').click();
      }
    });
  </script>
</body>
</html>